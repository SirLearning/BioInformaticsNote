[[BioInformaticsNote/3Program/Database/README|README]]

# 分布式数据库系统

**定义**
- 分布式数据库系统（DDBMS）是地理上分布在网络的不同节点，但在逻辑上属于同一个系统的数据库系统。

**特点**
- **数据分布**：数据物理上分布在不同的节点上。
- **数据逻辑相关**：逻辑上仍然是一个整体。
- **节点自治性**：每个节点可以独立管理和控制自己的数据。

组成
- **局部数据库管理系统（LDBMS）**：管理本地数据。
- **全局数据库管理系统（GDBMS）**：管理全局数据。
- **全局数据字典（GDD）**：存储全局数据的元数据。
- **网络通信管理（CM）**：管理节点之间的通信。

**同构系统与异构系统**
- **同构系统**：所有节点使用相同的数据库管理系统和数据模型，数据模式相同。
- **异构系统**：不同节点可能使用不同的数据库管理系统和数据模型。

优点
- 自治性好：不同部门的数据可按需定制、局部控制
- 效率高，可用性好：就近存放、多副本增加可用性
- 提高资源利用率：可以将已有数据库联合成DDB
- 结构灵活，易于扩充：新应用增加新结点，不用修改原数据库系统

体系结构（模式结构）
- 参考体系结构
	- 全局外模式：全局应用的用户视图
	- **全局概念模式**：全体数据的逻辑结构和特征的描述
	- **分片模式**：描述全局关系的分片情况
		- 描述每个片段及全局关系与片段间的映象， 片段间不允许重复
	- **分布模式**：描述数据片段的分布情况
		- 描述片段到不同结点间的映象（片段的存放位置）。如果规定一个片段仅能存放在一个结点，则是非冗余的，否则是冗余的。
	- **局部概念模式**：描述局部数据的逻辑结构，是对全局关系在这个结点上物理图象的逻辑结构及特征的描述
	- **局部内模式**：描述局部概念模式涉及的数据在局部DBMS中的物理存储
- 数据分片：分布式数据库中的所有数据时分布在不同节点上的
	- 分片方式遵循规则：
		- 完整性---全局关系的所有数据都必须分配到各个片段。
		- 重构性---分裂后的各个片段可以重构原来的全局关系。
		- 不相交性 ---全局关系中的每个元组仅属于一个片段。
	- 分片方式：
		- 水平分片---按元组分
		- 垂直分片----按列分
		- 导出分片----由其它关系导出
- 分布透明性
	- 分片透明性：关系如何分片对用户是透明的，指用户不必关心数据是如何分片的。其应用程序的编写与集中式数据库相同
	- 位置透明性 (较常用）：用户需知道数据在哪个片段，而不必知道所操作的数据放在哪个节点。 数据在结点间的转移不会影响应用程序
	- 局部映象透明性：该透明性提供数据到局部数据库的映象。在编程时不但需要了解全局关系的分片模式，还需要了解各片段存放的站点
	- 无透明性

# 分布式查询处理与优化

预备知识：集中式数据库的查询和优化
- **查询优化**：关系查询优化是影响RDBMS性能的关键因素。
- 查询代价
	- **集中式数据库的查询代价**：总代价 = I/O 代价 + CPU 代价。
	- **分布式数据库的查询代价**：I/O 代价 + CPU 代价 + 通信代价。
- **查询优化器**：是RDBMS服务器的一个组成部分
	- **基本任务**：通过产生多个可供选择的执行计划，找到最低估算成本的执行计划来优化一条SQL语句，以提高RDBMS的查询效率
- **DMBS实现查询优化的一般步骤**：
	1. **语法树转换**：将查询需求转换成语法树。
	2. **标准形式**：根据等价变换规则将语法树转换成标准形式。
	3. **选择操作算法**：选择具体的执行算法。
	4. **生成查询计划**：生成多个执行方案，选择代价最小的一个执行。
- **查询优化的一般策略**
	- **选择运算应尽早执行**：减少中间结果的元组数。
	- **投影运算和选择运算同时进行**：减少操作时间。
	- **把投影操作与它前面或后面的一个双目运算结合起来**：减少扫描次数。
	- 在执行连接运算之前，可对需要连接的关系进行适当地预处理，如建索引或排序：建索引或排序。
	- 把笛卡尔乘积和其后的选择运算合并成为连接运算：避免扫描笛卡尔乘积的中间结果
	- **存储公用子表达式**：避免重复计算。
- 连接运算的等价公式
	- 连接运算的可交换和可结合性
	- 连接对并、交、差的可分配性
	- 投影运算串接的等价公式
	- 选择运算串接的等价公式
	- 选择运算与投影运算交换的等价公式
	- 选择运算与笛卡尔积交换的接等价公式

分布式查询处理：步骤如下
- 将一个全局查询直接映射为对片段的查询
- 将片段的查询映射为对相应结点的查询
- 由结点上的局部DBMS执行子查询

分布式查询优化
- 查询代价：CPU代价 + I/O代价 + 通信代价
- 分类：全局优化、局部优化
- 全局优化需解决的主要问题：
	- 多副本的选择  
	- 执行次序的选择：  主要确定多元连接的连接次序
	- 连接方法的选择：  嵌套循环、合并扫描、半连接 
	- 执行结点的选择
- 方法：
	- n嵌套循环法
	- n合并扫描法
- 半连接

# 分布式事务管理

事务（Transaction）： 是用户定义的一个数据库操作序列，是数据恢复和并发控制的基本单位，数据库系统在执行事务时，要么执行事务中全部操作，要么一个操作都不执行。
- **事务的性质（ACID准则）**
	- **原子性（Atomicity）**：事务要么全执行，要么全不执行。
	- **一致性（Consistency）**：事务执行结果必须使数据库从一个一致状态变到另一个一致状态。
	- **隔离性（Isolation）**：事务更新的数据在事务结束前对其他事务不可见。
	- **持久性（Durability）**：已完成事务对数据的更新应持久，发生故障应恢复。
- 在应用程序中定义事务方法
	- 用户定义方法
	- 系统缺省方法
- 分布式事务：一个分布式事务由主事务（负责事务的开始、提交或异常中终止）和多个子事务（完成对数据的操作）组成
	- 分布式事务管理程序：事务处理和协调程序二部分组成
	- 分布式事务处理：分布式并发控制和事务恢复

分布式事务管理：分布事务管理和局部事务管理
- **分布式事务的并发控制**：确保多个事务并发执行时的一致性
	- 集中式数据库的并发控制：
		- 串行访问：当多个事务对数据库进行操作时，各个事务按顺序执行，即一个事务执行完全结束后，另一个事务才开始。
		- 并发访问：当多个事务对数据库进行操作时，各事务的执行在时间上有重叠。
		- 交叉并发：在单CPU系统中，多个事务交叉使用CPU。
		- 同时并发：在多CPU系统中，多个事务同时占用CPU。
		- DBMS对事务采用并发机制的主要目的：
			- 改善系统的资源利用率
			- 改善短事务的响应时间
		- DBMS对事务采用并发机制的方法
		- 死锁：T1和T2这两个事务永远不能结束，从而形成死锁
		- 解决死锁问题的方法：
			- 预防法
			- 诊断解除法
	- 分布式事务可串行化： 多个事务并行调度执行结果与他们按某一串行执行的结果相同，称这些事务的调度执行是可串行化的
		- 概念：
			- 调度：指事务处理执行操作的一个序列
			- 事务的操作分为两类：Ri(x)、Wi(x)
			- 串行调度序列S1：RWRWR
			- 冲突操作：若二个事务同时对数据目标X操作，其中之一是写操作，则这二个操作是冲突的
			- 并行调度序列S2：RRWWR
			- 冲突等价：同一个事务集的不同调度序列中，任一对冲突操作在调度S1中Oi优先Oj而在调度S2中也Oi优先Oj，则这两个调度冲突等价。
		- 满足以下条件：
			- 每个局部结点上的调度Sp都是可串行化的；
			- 存在一个对T1,T2,...,Tk的综合顺序使得在该顺序中事务Ti<Tj，则对T1,T2,...,Tk每个局部结点上的可串行化调度Sp在等价的串行调度Sp'中有事务Ti<Tj。
	- 基于封锁的并发控制：
		- 并发操作不当带来的数据不一致性的表现：丢失修改、不可重复读、读“脏”数据
			- 为了保证数据库的一致性，DBMS需要提供并发控制机制，以保证并发操作的正确性
		- 封锁协议（Locking Protocol）：
			- 研究内容：何时申请锁、锁的类型（共享锁S、排它锁X）、持锁时间、何时释放锁、使用锁的规则
			- 二段锁协议(Two-Puase Looking    2PL协议)：
				- 两个阶段：
					- 第一阶段是获得封锁，也称为扩展阶段。任何事务在对数据操作前必须先获得锁
					- 第二阶段是释放封锁，也称为收缩阶段。事务在释放一个锁后不再获得任何锁
				- 结论：
					- 在集中式数据库中若所有事务都遵循2PL协议，则多个事务的交叉执行是可串行化的。
					- 在分布式数据库中，若所有事务都遵循2PL，则分布事务的调度执行是可串行化的。
	- 基于时戳（Time Stamp）的并发控制
		- 以时戳的顺序处理冲突，基本时戳法遵循准则：
			- 每个事务T开始时，在发生结点赋予时戳TS
			- 事务的读、写操作都带有该事务的时戳
			- 每个数据X分别有最大时戳RTM(X)和WTM(X)
			- 若事务T读X，TS < WTM(X) 则拒绝并用新的时戳重新启动，否则执行读操作，RTM(X)置为max(RTM(X), TS)
			- 事务写X，TS < RTM(X) 或 TS < WTM(X)，拒绝写并用新的时戳重新启动，否则执行写并置WTM(X)为TS
		- 结论：基于时戳的并发控制使得事务的并行执行等价于以时戳顺序确定的一个特定的串行序列
- **分布式事务的故障恢复**：恢复因故障而中断的事务
	- 集中式数据库系统中的恢复：事务恢复的目的是当数据库出现故障时能恢复到一个正确一致的状态，恢复的手段主要是利用转储和日志。
		- 转储：数据库管理员定期将整个数据库复制到磁带或另一个磁盘上保存起来的过程。
		- 日志：保存每一次对数据库进行更新操作的有关信息的文件，由DBMS自动建立和记录。
			- 日志文件的主要内容：
				- 事务处理的标识符（开始、结束）
				- 操作的类型（插入、删除、修改）
				- 更新前的值
				- 更新后的值
			- 检查点机制：为了便于恢复，在日志中每隔一定时间（如10分钟）写一个检查点，以标识检查点前已经执行完的事务是正确的。
		- 事务恢复的原则
			- 对事务内部的故障，不影响其它事务，将事务回退(UNDO)
			- 已提交的事务应该满足事务的持久性, 发生故障后应该重做 (REDO) 它所做过的所有修改数据库的操作
			- 对非事务内部的故障，如系统崩溃等引起事务夭折。所有正在执行的事务都需要撤消(UNDO)
		- 故障种类及其恢复步骤：
			- 事务故障：
				1. 反向扫描文件日志（即从最后向前扫描日志文件），查找该事务的更新操作。
				2. 对该事务的更新操作执行逆操作。
				3. 反向扫描，直至读到此事务的开始标志，事务故障恢复就完成了。
			- 系统故障：
				1. 正向扫描日志文件（从头扫描日志文件）
					- 找出在故障发生前已经提交的事务，将其事务标识记入重做（REDO）队列。
					- 找出故障发生时尚未完成的事务，将其事务标识记入撤销（UNDO）队列。
				2. 对撤销队列中的各个事务进行撤消处理。（UNDO）
				3. 对重做队列中的各个事务进行重做处理。（REDO）
			- 介质故障：
				- 装入后备副本，重做已完成的事务
				- 装入有关日志文件的副本 ：
					- 首先扫描日志文件，找出故障发生时已提交的事务的标识，将其记入重做队列。
					- 然后正向扫描日志文件，对重做队列中的所有事务进行重做处理。即将日志记录中“更新后的值”写入数据库。
		- 具有检查点记录的恢复步骤
			1. 从重启动文件中找出最近一个检查点记录地址；
			2. 得到检查点时刻事务清单；
			3. 从检查点以后，正向扫描日志文件，将已经完成的事务放入重做队列，对未完成的事务放入撤消队列。
			4. 对重做队列中的事务执行REDO操作；
			5. 对撤消队列中的事务执行UNDO操作。
	- 分布式数据库系统中的恢复
		- 分布式数据库中的故障：结点故障、通信故障(信息丢失和网络分割)。
		- 恢复的单位是事务，故障发生前已完成的事务都在恢复之列。
		- 分布式事务的恢复分为三个层次：
			1. 仅处理结点故障；
			2. 仅处理结点和信息丢失二种故障；
			3. 同时能够处理结点故障、信息丢失和网络分割三种故障。
		- **事务的提交协议**：分布式事务的提交通过协调程序完成，子事务站点为参与者，执行协调程序的站点为协调者。
			- **二阶段提交协议（2PC）**
				- 两个阶段：
					- **准备提交阶段**：协调者发送Prepare消息，参与者回复Ready或Abort。
					- **提交阶段**：协调者发送Commit或Abort消息，参与者执行相应操作。
				- 故障处理：
					- 站点故障：参与者与协调者不同处理
						- 参与者的处理
						- 协调者的处理
					- 报文丢失：第一阶段、第二阶段
					- 网络分割：
						- 协调者子网
						- 参与者子网
				- 2PC协议存在的问题：阻塞
			- **三阶段提交协议（3PC）**
				- 阶段：
					- **第一阶段**：同2PC协议。
					- **第二阶段**：协调者发送Enter-Prepare-State消息，参与者回复OK。
					- **第三阶段**：协调者发送Commit消息，参与者执行提交操作。
				- 故障处理：
					- 参与者结点的故障
					- 协调者故障
	- 多副本的更新：
		- 更新主副本：仅更新主副本，其它副本的更新在事务结束后由主副本负责更新。对非主副本的操作要等到更新结束后才能进行。 “活动主副本”。
		- 结点保留一张表，记录每个不可更新的结点
		- 快照：数据在某一时刻的状态,存储在外存上，定期刷新。快照仅提供读操作。

# 分布式目录

目录(Catalog)：一个“微小DB”, 描述DB的元数据(metadata)
- 内容：全局模式描述、分片模式描述、分布模式描述、局部名映射、存取方式描述、数据库统计信息、元组长度、存放空间、一致性约束、状态信息、数据表示、系统描述

分布式目录需要实现：目录的存储、存取、并发控制和恢复

目录分布策略：
- 集中式：系统目录集中存放在一个节点，其它节点都需要访问该节点上的目录数据。
- 全复制式目录：每个节点都有一个目录的副本。
- 部分复制式  ：部分站点、部分目录。

不同分布式数据库系统中的目录分布和管理
- SDD-1
- System R*
- ORACLE

# 数据库的安全保护：保护数据库免受非法访问和恶意攻击。

DBMS层所提供的数据库安全和保护功能：
- 安全性 (security) 保护
- 完整性 (integrity) 保护
- 并发控制 (concurrent control)
- 数据库恢复 (database recovery)

用户鉴别

存取权限控制
- 对每个用户，可以定义以下两种存取控制权限：
	- 数据对象权限：规定了用户使用数据库中数据对象的范围；
	- 操作类型权限：规定了用户在可使用数据对象上能执行的操作； 
- 授权
- 存取控制权的管理方式：集中方式、分散方式
- 关系系统中的存取权限
- 授权机制灵活性的一个指标：授权粒度，即存取权限可以定义的数据对象的范围

视图机制

跟踪审查：一种事后监视的安全性保护措施，它跟踪数据库的访问活动，以发现数据库的非法访问，达到安全防范的目的
- 跟踪审查记录：记录跟踪审查结果是一个特殊文件。一般包括下列内容
	- 操作类型（例如修改、查询等）
	- 操作终端标识与操作者标识
	- 操作日期和时间
	- 所涉及的数据
	- 数据的前像和后像

数据加密存储

# 数据库的完整性保护

**完整性**：防止合法用户使用数据库时向数据库中加入不合语义的数据，即防范的对象是不合语义的数据。

**完整性约束**：实体完整性、参照完整性、用户定义的完整性。
- 作用对象：列、元组和关系三种级别
- 作用状态：静态约束条件和动态约束条件两种
- 分类：
	- 静态列级约束：对一个列的取值域的说明，比如数据类型、范围。
	- 静态元组约束：规定组成一个元组的各列值之间的约束关系。
	- 静态关系约束：在一个关系的各个元组之间或若干关系之间的各种联系和约束，比如：实体完整性约束、参照完整性约束、函数依赖
	- 动态列级约束：修改定义或修改列值时应满足的约束条件。
	- 动态元组约束：修改某个元组的值时应满足的约束条件。
	- 动态关系约束：关系变化前后状态上的限制条件。

**完整性机制**
- DBMS完整性控制应具有的功能：定义功能、检查功能、保护功能
- 商品化关系数据库管理系统(RDBMS)把完整性约束分为：
	- 实体完整性约束；
	- 参照完整性约束；
	- 用户定义的完整性约束，即所有非⑴、⑵的完整性约束。
- 完整性的控制方法：实体完整性约束、参照完整性约束、用户定义的完整性约束
- 元组中主键值的修改问题
	- 不允许修改主键值
	- 允许修改主键值，但必须保证主键值的唯一性和非空，否则拒绝修改
		- 当修改的关系是被参照关系，而参照关系存在这样的元组，其外键值等于被参照关系要修改的主键值时，有3种处理策略：级联修改、拒绝修改、置空值修改
		- 当修改的关系是参照关系，而被参照关系存在这样的元组，其主键值等于被参照关系要修改的外键值时，有2种处理策略： 受限修改、递归修改

触发器 (Triggers) ：建立(附着)在某个关系(基本表)上的一系列SQL语句的集合(程序)，且经预先编译后存储在数据库中
- 功能：实现数据库的完整性约束和安全保护
- 优点：比由完整性约束条件实现的完整性约束要强的多，且更加灵活
